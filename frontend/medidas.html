<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Medidas Corporais - Olympus App</title>
    <link rel="shortcut icon" href="imgs/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="css/padrao.css"> 
    <link rel="stylesheet" href="css/medidas.css">
</head>
<body>
    <header>
        <h1><a href="index.html" style="text-decoration: none; color: inherit;">Olympus App</a></h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="exercicios.html">Exercícios</a>
            <a href="profile.html">Perfil</a>
            <a href="login.html">Sair</a>
        </nav>
    </header>

    <main>
        <h1>Acompanhamento Corporal</h1>

        <section id="registro-medidas">
            <h2>Registrar Medições de Hoje</h2>
            <form id="form-medidas">
                <div class="form-row">
                    <div class="form-group-medida">
                        <label for="peso">Peso (Kg):</label>
                        <input type="number" id="peso" name="peso" step="0.1" min="1" placeholder="Ex: 80.5" required>
                    </div>
                    
                    <div class="form-group-medida">
                        <label for="ombros">Ombros (cm):</label>
                        <input type="number" id="ombros" name="ombros" step="0.1" min="1" placeholder="Ex: 120.0">
                    </div>

                    <div class="form-group-medida">
                        <label for="peitoral">Peitoral (cm):</label>
                        <input type="number" id="peitoral" name="peitoral" step="0.1" min="1" placeholder="Ex: 105.0">
                    </div>

                    <div class="form-group-medida">
                        <label for="bicepsE">Bíceps Esquerdo (cm):</label>
                        <input type="number" id="bicepsE" name="bicepsE" step="0.1" min="1" placeholder="Ex: 38.0">
                    </div>

                    <div class="form-group-medida">
                        <label for="bicepsD">Bíceps Direito (cm):</label>
                        <input type="number" id="bicepsD" name="bicepsD" step="0.1" min="1" placeholder="Ex: 38.5">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-medida">
                        <label for="antebracoE">Antebraço Esquerdo (cm):</label>
                        <input type="number" id="antebracoE" name="antebracoE" step="0.1" min="1" placeholder="Ex: 30.0">
                    </div>

                    <div class="form-group-medida">
                        <label for="antebracoD">Antebraço Direito (cm):</label>
                        <input type="number" id="antebracoD" name="antebracoD" step="0.1" min="1" placeholder="Ex: 30.5">
                    </div>

                    <div class="form-group-medida">
                        <label for="cintura">Cintura (cm):</label>
                        <input type="number" id="cintura" name="cintura" step="0.1" min="1" placeholder="Ex: 85.0" required>
                    </div>

                    <div class="form-group-medida">
                        <label for="quadril">Quadril (cm):</label>
                        <input type="number" id="quadril" name="quadril" step="0.1" min="1" placeholder="Ex: 95.0">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group-medida">
                        <label for="coxaE">Coxa Esquerda (cm):</label>
                        <input type="number" id="coxaE" name="coxaE" step="0.1" min="1" placeholder="Ex: 60.0">
                    </div>

                    <div class="form-group-medida">
                        <label for="coxaD">Coxa Direita (cm):</label>
                        <input type="number" id="coxaD" name="coxaD" step="0.1" min="1" placeholder="Ex: 60.5">
                    </div>

                    <div class="form-group-medida">
                        <label for="panturrilhaE">Panturrilha Esquerda (cm):</label>
                        <input type="number" id="panturrilhaE" name="panturrilhaE" step="0.1" min="1" placeholder="Ex: 38.0">
                    </div>

                    <div class="form-group-medida">
                        <label for="panturrilhaD">Panturrilha Direita (cm):</label>
                        <input type="number" id="panturrilhaD" name="panturrilhaD" step="0.1" min="1" placeholder="Ex: 38.5">
                    </div>
                </div>

                <input type="submit" value="Salvar Medições" class="input-submit">
            </form>
        </section>
        
        <section id="visao-geral">
            <h2>Medidas Mais Recentes</h2>
            <div class="medidas-atuais">
                <div class="medida-item">
                    <span class="valor" id="peso-atual">—</span>
                    <span class="label">Peso (Kg)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="ombros-atual">—</span>
                    <span class="label">Ombros (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="peitoral-atual">—</span>
                    <span class="label">Peitoral (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="bicepsE-atual">—</span>
                    <span class="label">Bíceps E (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="bicepsD-atual">—</span>
                    <span class="label">Bíceps D (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="antebracoE-atual">—</span>
                    <span class="label">Antebraço E (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="antebracoD-atual">—</span>
                    <span class="label">Antebraço D (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="cintura-atual">—</span>
                    <span class="label">Cintura (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="quadril-atual">—</span>
                    <span class="label">Quadril (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="coxaE-atual">—</span>
                    <span class="label">Coxa E (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="coxaD-atual">—</span>
                    <span class="label">Coxa D (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="panturrilhaE-atual">—</span>
                    <span class="label">Panturrilha E (cm)</span>
                </div>
                <div class="medida-item">
                    <span class="valor" id="panturrilhaD-atual">—</span>
                    <span class="label">Panturrilha D (cm)</span>
                </div>
            </div>
        </section>
        
    </main>

    <footer class="site-footer">
        <div class="footer-inner">
            <small>© <span id="year"></span> Olympus App</small>
            <nav class="footer-links" aria-label="Links úteis">
                <a href="sobre.html">Sobre</a>
                <a href="termos.html">Termos</a>
                <a href="privacidade.html">Privacidade</a>
                <a href="cancelamentos.html">Cancelamentos</a>
            </nav>
        </div>
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        const API = 'http://localhost:3000';
        const formMedidas = document.getElementById('form-medidas');

        async function carregarMedidasRecentes() {
            const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
            if (!usuario || !usuario.id) return;

            try {
                // peso
                const respPeso = await fetch(`${API}/buscaPesoCorporal?id_usuario=${usuario.id}`);
                if (respPeso.ok) {
                    const pesos = await respPeso.json();
                    if (Array.isArray(pesos) && pesos.length > 0) {
                        pesos.sort((a,b)=> b.dia_pesoCorporal.localeCompare(a.dia_pesoCorporal));
                        document.getElementById('peso-atual').textContent = parseFloat(pesos[0].peso_pesoCorporal).toFixed(1);
                    }
                }

                // medidas corporais
                const respMed = await fetch(`${API}/buscaMedidaCorporal?id_usuario=${usuario.id}`);
                if (respMed.ok) {
                    const meds = await respMed.json();
                    if (Array.isArray(meds) && meds.length > 0) {
                        // procurar por região mais recente (compare data DESC)
                        const latestByReg = {};
                        meds.forEach(m => {
                            const reg = (m.regiao_medidaCorporal || '').toLowerCase();
                            if (!latestByReg[reg] || m.dia_medidaCorporal > latestByReg[reg].dia_medidaCorporal) {
                                latestByReg[reg] = m;
                            }
                        });
                        
                        if (latestByReg['ombros']) document.getElementById('ombros-atual').textContent = parseFloat(latestByReg['ombros'].medida_cm).toFixed(1);
                        if (latestByReg['peitoral']) document.getElementById('peitoral-atual').textContent = parseFloat(latestByReg['peitoral'].medida_cm).toFixed(1);
                        if (latestByReg['bíceps esquerdo'] || latestByReg['biceps esquerdo']) document.getElementById('bicepsE-atual').textContent = parseFloat((latestByReg['bíceps esquerdo'] || latestByReg['biceps esquerdo']).medida_cm).toFixed(1);
                        if (latestByReg['bíceps direito'] || latestByReg['biceps direito']) document.getElementById('bicepsD-atual').textContent = parseFloat((latestByReg['bíceps direito'] || latestByReg['biceps direito']).medida_cm).toFixed(1);
                        if (latestByReg['antebraço esquerdo'] || latestByReg['antebraco esquerdo']) document.getElementById('antebracoE-atual').textContent = parseFloat((latestByReg['antebraço esquerdo'] || latestByReg['antebraco esquerdo']).medida_cm).toFixed(1);
                        if (latestByReg['antebraço direito'] || latestByReg['antebraco direito']) document.getElementById('antebracoD-atual').textContent = parseFloat((latestByReg['antebraço direito'] || latestByReg['antebraco direito']).medida_cm).toFixed(1);
                        if (latestByReg['cintura']) document.getElementById('cintura-atual').textContent = parseFloat(latestByReg['cintura'].medida_cm).toFixed(1);
                        if (latestByReg['quadril']) document.getElementById('quadril-atual').textContent = parseFloat(latestByReg['quadril'].medida_cm).toFixed(1);
                        if (latestByReg['coxa esquerda']) document.getElementById('coxaE-atual').textContent = parseFloat(latestByReg['coxa esquerda'].medida_cm).toFixed(1);
                        if (latestByReg['coxa direita']) document.getElementById('coxaD-atual').textContent = parseFloat(latestByReg['coxa direita'].medida_cm).toFixed(1);
                        if (latestByReg['panturrilha esquerda']) document.getElementById('panturrilhaE-atual').textContent = parseFloat(latestByReg['panturrilha esquerda'].medida_cm).toFixed(1);
                        if (latestByReg['panturrilha direita']) document.getElementById('panturrilhaD-atual').textContent = parseFloat(latestByReg['panturrilha direita'].medida_cm).toFixed(1);
                    }
                }
            } catch (err) {
                console.error('Erro ao carregar medidas recentes:', err);
            }
        }

        // Submeter medidas para o backend
        formMedidas.addEventListener('submit', async function(e) {
            e.preventDefault();

            const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
            if (!usuario || !usuario.id) { alert('Você precisa estar logado para salvar medidas.'); return; }

            const hoje = new Date().toISOString().split('T')[0];

            // campos e mapeamento para nomes de região
            const medidas = {
                peso: document.getElementById('peso').value,
                ombros: document.getElementById('ombros').value,
                peitoral: document.getElementById('peitoral').value,
                bicepsE: document.getElementById('bicepsE').value,
                bicepsD: document.getElementById('bicepsD').value,
                antebracoE: document.getElementById('antebracoE').value,
                antebracoD: document.getElementById('antebracoD').value,
                cintura: document.getElementById('cintura').value,
                quadril: document.getElementById('quadril').value,
                coxaE: document.getElementById('coxaE').value,
                coxaD: document.getElementById('coxaD').value,
                panturrilhaE: document.getElementById('panturrilhaE').value,
                panturrilhaD: document.getElementById('panturrilhaD').value
            };

            // validar peso obrigatório
            if (!medidas.peso || !medidas.cintura) { 
                alert('Peso e cintura são obrigatórios.'); 
                return; 
            }

            try {
                // salvar peso
                if (medidas.peso) {
                    const respPeso = await fetch(`${API}/cadastraPesoCorporal`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_usuario: usuario.id, dia_pesoCorporal: hoje, peso_pesoCorporal: Number(medidas.peso), meta_peso: 0 })
                    });
                    if (!respPeso.ok) {
                        const txt = await respPeso.text();
                        throw new Error(`Erro ao salvar peso: ${respPeso.status} ${txt}`);
                    }
                }

                // salvar cada medida corporal
                const regioes = [
                    ['Ombros', medidas.ombros],
                    ['Peitoral', medidas.peitoral],
                    ['Bíceps Esquerdo', medidas.bicepsE],
                    ['Bíceps Direito', medidas.bicepsD],
                    ['Antebraço Esquerdo', medidas.antebracoE],
                    ['Antebraço Direito', medidas.antebracoD],
                    ['Cintura', medidas.cintura],
                    ['Quadril', medidas.quadril],
                    ['Coxa Esquerda', medidas.coxaE],
                    ['Coxa Direita', medidas.coxaD],
                    ['Panturrilha Esquerda', medidas.panturrilhaE],
                    ['Panturrilha Direita', medidas.panturrilhaD]
                ];

                const requests = regioes
                    .filter(([_, val]) => val)
                    .map(([reg, val]) =>
                        fetch(`${API}/cadastraMedidaCorporal`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id_usuario: usuario.id, dia_medidaCorporal: hoje, regiao_medidaCorporal: reg, medida_cm: Number(val) })
                        }).then(r => {
                            if (!r.ok) throw new Error(`Erro ao salvar ${reg}: ${r.status}`);
                            return r.json();
                        })
                    );

                await Promise.all(requests);

                alert('Medidas registradas com sucesso para hoje!');
                formMedidas.reset();
                
                // Aguardar um pouco e recarregar para garantir que os dados foram persistidos
                setTimeout(() => {
                    carregarMedidasRecentes();
                }, 500);
            } catch (err) {
                console.error('Erro ao salvar medidas:', err);
                alert('Não foi possível salvar as medidas. Tente novamente.');
            }
        });

        carregarMedidasRecentes();
    </script>
</body>
</html>