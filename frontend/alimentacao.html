<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Alimentação - Olympus App</title>
    <link rel="shortcut icon" href="imgs/favicon.png" type="image/x-icon">
    <link rel="stylesheet" href="css/padrao.css"> 
    <link rel="stylesheet" href="css/alimentacao.css">
</head>
<body>
    <header>
        <h1><a href="index.html" style="text-decoration: none; color: inherit;">Olympus App</a></h1>
        <nav>
            <a href="index.html">Home</a>
            <a href="exercicios.html">Exercícios</a>
            <a href="profile.html">Perfil</a>
            <a href="login.html">Sair</a>
        </nav>
    </header>

    <main>
        <h1>Registro Alimentar do Dia</h1>

        <div id="contador-calorias">
            Total de Calorias Consumidas: <span id="total-calorias">0</span> Kcal
        </div>

        <section id="registro-refeicao">
            <h2>Adicionar Nova Refeição</h2>
            <form id="form-refeicao">
                <div class="form-group">
                    <label for="alimento">Alimento/Refeição:</label>
                    <input type="text" id="alimento" name="alimento" placeholder="Ex: Frango Grelhado (150g)" required>
                </div>
                
                <div class="form-group">
                    <label for="calorias">Calorias (Kcal):</label>
                    <input type="number" id="calorias" name="calorias" min="1" placeholder="Ex: 350" required>
                </div>

                <input type="submit" value="Registrar Refeição" class="input-submit">
            </form>
        </section>

        <section id="lista-refeicoes">
            <h2>Refeições Registradas</h2>
            <ul id="refeicoes-dia">
                </ul>
            <p id="sem-refeicoes" style="text-align: center; color: #888;">Nenhuma refeição registrada ainda.</p>
        </section>
        
    </main>

    <footer class="site-footer">
        <div class="footer-inner">
            <small>© <span id="year"></span> Olympus App</small>
            <nav class="footer-links" aria-label="Links úteis">
                <a href="sobre.html">Sobre</a>
                <a href="termos.html">Termos</a>
                <a href="privacidade.html">Privacidade</a>
                <a href="cancelamentos.html">Cancelamentos</a>
            </nav>
        </div>
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        const API = 'http://localhost:3000';
        const form = document.getElementById('form-refeicao');
        const listaRefeicoes = document.getElementById('refeicoes-dia');
        const totalCaloriasSpan = document.getElementById('total-calorias');
        const semRefeicoes = document.getElementById('sem-refeicoes');
        let totalCalorias = 0;

        function formatDatePT(d) {
            if (!d) return '';
            if (typeof d === 'string' && d.indexOf('-') >= 0) {
                const parts = d.split('-');
                if (parts.length >= 3) {
                    const dayPart = parts[2].split('T')[0];
                    return `${dayPart}/${parts[1]}/${parts[0]}`;
                }
            }
            try { return new Date(d).toLocaleDateString('pt-BR'); } catch(e) { return d; }
        }

        // Função para atualizar o contador de calorias
        function atualizarContador() {
            totalCaloriasSpan.textContent = totalCalorias;
            if (listaRefeicoes.children.length === 0) {
                semRefeicoes.style.display = 'block';
            } else {
                semRefeicoes.style.display = 'none';
            }
        }

        // Carrega refeições do usuário para hoje
        async function carregarRefeicoesDoDia() {
            listaRefeicoes.innerHTML = '';
            totalCalorias = 0;

            const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
            if (!usuario || !usuario.id) {
                semRefeicoes.textContent = 'Usuário não logado.';
                return;
            }

            // busca pelo dia atual
            const hoje = new Date().toISOString().split('T')[0];
            try {
                const resp = await fetch(`${API}/buscaRefeicao?id_usuario=${usuario.id}&dia_refeicao=${hoje}`);
                if (!resp.ok) {
                    semRefeicoes.textContent = 'Erro ao carregar refeições.';
                    return;
                }
                const items = await resp.json();
                if (!Array.isArray(items) || items.length === 0) {
                    semRefeicoes.style.display = 'block';
                    return;
                }

                items.forEach(r => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="info-refeicao">${r.descricao_refeicao}</span>
                        <span class="calorias-refeicao">${r.id_refeicao ? '' : ''}</span>
                        <small class="data-refeicao">${formatDatePT(r.dia_refeicao)}</small>
                    `;
                    listaRefeicoes.appendChild(li);
                    // tentar extrair calorias do texto (se o front envia 'Alimento (150g) - 350 Kcal')
                    const match = (r.descricao_refeicao||'').match(/(\d+)\s*Kcal/i);
                    if (match) totalCalorias += Number(match[1]);
                });

                atualizarContador();
            } catch (err) {
                console.error('Erro ao carregar refeições:', err);
                semRefeicoes.textContent = 'Erro ao carregar refeições.';
            }
        }

        // Função para adicionar uma nova refeição (agora salva no backend)
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const alimentoInput = document.getElementById('alimento');
            const caloriasInput = document.getElementById('calorias');

            const alimento = alimentoInput.value.trim();
            const calorias = parseInt(caloriasInput.value);

            if (!(alimento && calorias > 0)) {
                alert('Por favor, preencha o nome do alimento e a quantidade de calorias (deve ser um valor positivo).');
                return;
            }

            const usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
            if (!usuario || !usuario.id) {
                alert('Você precisa estar logado para registrar refeições.');
                return;
            }

            const hoje = new Date().toISOString().split('T')[0];
            const descricao = `${alimento} — ${calorias} Kcal`;

            try {
                const resp = await fetch(`${API}/cadastraRefeicao`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id_usuario: usuario.id, dia_refeicao: hoje, descricao_refeicao: descricao })
                });

                if (!resp.ok) {
                    const txt = await resp.text();
                    throw new Error(`${resp.status} ${txt}`);
                }

                // atualizar lista localmente recarregando do servidor
                alimentoInput.value = '';
                caloriasInput.value = '';
                await carregarRefeicoesDoDia();
            } catch (err) {
                console.error('Erro ao salvar refeição:', err);
                alert('Não foi possível salvar a refeição. Tente novamente.');
            }
        });

        // Inicializa o contador e a mensagem de "sem refeições"
        carregarRefeicoesDoDia();

    </script>
</body>
</html>